# Testing Guide

This guide captures the current state of automated coverage and the recommended manual checks before shipping changes.

## Targets & Coverage Snapshot
- **WhiteNoiseUnitTests**
  - `TimerServiceTests.swift` exercises the start/pause/resume/stop lifecycle with a real async countdown.
  - Note: the test references `TimerService.remainingSecondsValue`, which the production class no longer exposes. Either reintroduce the accessor or update the tests to observe state via existing APIs before running.
- **WhiteNoiseUITests**
  - Template tests generated by Xcode (`WhiteNoiseUITests.swift`, `WhiteNoiseUITestsLaunchTests.swift`). These currently act as scaffolding—expand them when UI automation becomes relevant.

Expect additional units (sound playback, persistence migrations, fade operations) to be added as the code evolves.

## Running the Suite
```bash
# Build + unit/UI tests via xcodebuild
xcodebuild test \
  -project WhiteNoise.xcodeproj \
  -scheme WhiteNoise \
  -destination 'platform=iOS Simulator,name=iPhone 15'

# Helper script (wraps the same command)
bash scripts/test.sh
```

Tips:
- Use `clean build folder` (`xcodebuild clean`) if cached builds cause simulator oddities.
- Pass `DESTINATION="platform=iOS Simulator,name=iPhone 16"` (or similar) to target a different simulator.

## Writing New Tests
- Depend on protocols to inject stubs/mocks (`AudioPlayerFactoryProtocol`, `SoundPersistenceServiceProtocol`, `RemoteCommandHandling`, etc.).
- Keep asynchronous tests on the main actor when touching UI-bound types: `let sut = await MainActor.run { WhiteNoisesViewModel(...) }` and use `await MainActor.run { ... }` for assertions.
- Use `XCTestExpectation` or `XCTWaiter` when validating timer ticks, fade completion, or persistence callbacks.
- Prefer narrow-scope tests that focus on a single responsibility (e.g., timer expiry calls pause, fade cancels on new play request).

## Manual QA Checklist
- **Audio Mixing**: Toggle multiple sounds, adjust volumes rapidly, and verify fades behave smoothly without clipping.
- **Timer Behaviour**: Start timers, pause/resume mid-countdown, let them expire, and confirm playback pauses with long fade.
- **Remote Commands** (iOS device/simulator with hardware keyboard shortcut): test play/pause/toggle from Control Center or lock screen.
- **Interruption Recovery**: Simulate phone call/audio interruption (use Control Center). App should pause and optionally resume if it was playing.
- **Variant Selection**: Switch between sound variants and validate the corresponding audio asset loads without crashing.

## Known Gaps (2025-09-16)
- No automated coverage for `SoundViewModel`, fade strategies, or persistence migrations—high-value candidates for future tests.
- UI tests are placeholders; a smoke test that taps play, toggles a sound, and verifies the timer overlay would catch regressions.
- Test reliability is sensitive to async timing; keep sleeps generous or refactor to await explicit callbacks when expanding coverage.

Update this guide whenever new suites, scripts, or manual procedures are introduced.
